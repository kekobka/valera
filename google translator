--@name google translator
--@author valera
--@server

local LANGfrom = "ru"
local LANGto = "en"







local function Decode(url)


    url = string.gsub(url, '&#39;', "'")
    url = string.gsub(url, '&quot;', '"')

    return url
end

function finder(txt,from,to,number,subFrom,subTo,pattern)
    local F = string.find(txt,from,number,pattern)
    if not F then return nil,"" end
    local F2 = string.find(txt,to,F,pattern)
    return  string.sub(txt,F+subFrom,F2+subTo)
end
local rawtranslate = ""
    WORKERS = {}
    WORKERS_QUOTA = 0.5
    
    local function canProcess()
        local exp1 = (math.max(quotaTotalAverage(), quotaTotalUsed()) + (quotaTotalUsed() - math.max(quotaTotalAverage(), quotaTotalUsed())) * 0.01) / quotaMax() < WORKERS_QUOTA
        local exp2 = math.max(quotaTotalAverage(), quotaTotalUsed()) < quotaMax() * WORKERS_QUOTA
        local exp3 = 1/timer.frametime()>30

        return exp1 and exp2 and exp3
    end
    
    local function execWorker(worker)
        local status
    
        while canProcess() do
            status = worker()
    
            if status == 1 or status == 2 then
                break
            end
        end
    
        return status
    end
    
    local function procWorkers()
        local i = 1
        while i <= #WORKERS do
            local status = execWorker(WORKERS[i])
    
            if status == 2 then
                table.remove(WORKERS, i)
            elseif status == 1 then
                i = i + 1
            else
                break
            end
        end
    
        if #WORKERS == 0 then
            hook.remove("think", "workers_think")
        end
    end
    
    function addWorker(worker)
        local status = execWorker(worker)
    
        if status ~= 2 then
            if #WORKERS == 0 then
                hook.add("think", "workers_think", procWorkers)
            end
    
            WORKERS[#WORKERS + 1] = worker
        end
    end
hook.add('PlayerSay', 'PlayerSay', function(ply, text)
    if text:sub(text:len()-string.len("  (translated)")+1) == '  (translated)' then return end
    addWorker(coroutine.wrap(function()
        while not http.canRequest() do
            coroutine.yield(1)
        end

    if ply == owner() then
        http.get("https://translate.google.com/m?sl="..LANGfrom.."&tl="..LANGto.."&hl=auto&q="..http.urlEncode(text).."&hl=ru", function(response)
            while not rawtranslate do
                coroutine.yield(1)
            end
            rawtranslate = response
            rawtranslate = Decode(finder(rawtranslate,'class="result-container"','</div>',1,string.len('class="result-container" '),-1,string.patternSafe("div")))
            rawtranslate = rawtranslate.."  (translated)"
            owner():say(rawtranslate)
        end)
    end
    if ply != owner() then
        http.get("https://translate.google.com/m?sl=auto&tl="..LANGfrom.."&hl=auto&q="..http.urlEncode(text).."&hl=ru", function(response)
            while not rawtranslate do
                coroutine.yield(1)
            end
            rawtranslate = response
            rawtranslate = Decode(finder(rawtranslate,'class="result-container"','</div>',1,string.len('class="result-container" '),-1,string.patternSafe("div")))
            print(team.getColor(ply:getTeam()),ply:getName(),Color(255,255,255),": "..rawtranslate,Color(255,0,0),"  (translated)")
        end)
    end
        return 2
    end))
end)
